# Azpen A746 Android Work

## Links

- [Dumped Stock ROM](https://1drv.ms/u/s!AhjgTI1qxX9xhpNCqEHOxzOVnvZi5w?e=kCeBIt): Stock ROM I dumped from my tablet. *I have not determined if the stock rom on these tablets contains malware. Use at your own risk.*
- [Allwinner A33 SDK](https://linux-sunxi.org/A33#Android_SDK): External source
- [Vendor Folder](https://1drv.ms/u/s!AhjgTI1qxX9xhpNBvHlxAAMYwv4KZw?e=F8SGcF): `/system/vendor` folder from my tablet
- [Azpen's Upgrade Tool for Allwinner](https://1drv.ms/u/s!AhjgTI1qxX9xhpNDvn_skCDfFlcx6g?e=K8zr6S)
- [Firmware Folder](https://1drv.ms/u/s!AhjgTI1qxX9xhpNEt8ftGKgPJkmDjg?e=avc3le): `/etc/firmware` folder from my tablet

<br />

- [Device Tree](https://github.com/MB3hel/android_device_azpen_along-6051)

## General Info

- **Note that this tablet uses the legacy sunxi 3.4 kernel and legacy sunxi uboot. Not mainline versions.**

From FEL mode:

`sunxi-fel ver`: `AWUSBFEX soc=00001667(A33) 00000001 ver=0001 44 08 scratchpad=00007e00 00000000 00000000`
`sunxi-fel sid`: `0461872a:87185201:9c9747a7:00000000`
`sunxi-fel read 0x01c23800`: `0x0461872a`


Extracted info from stock:

From [this](https://linux-sunxi.org/Retrieving_device_information) the FEL extract fails, but I have obtained `script.bin` and `script.fex` from the stock rom using the script extract tool (from [this](https://github.com/linux-sunxi/sunxi-tools)). These are located in the `stock/` folder. The bootinfo was also extracted using the SUN8I method in a modified meminfo script (I made SUN9I use SUN8I code). This is included, but I am not certain it is valid.

The `script.fex` was automatically converted to a `dts` file using [FEX2DTS](https://github.com/SdtElectronics/FEX2DTS). I have no idea if it's valid. But it is likely a good starting point.

There is also a partition map file, various command outputs (dmesg, dumpsys), and build.prop from the stock ROM. 

Other information (various command outputs) are in `info_from_stock.txt`.


## Boot Modes

### Enter Recovery

- Power fully off (not reboot)
- Hold Vol+
- Press and hold power for 5 seconds
- Release power (keep holding vol+)
- Wait until recovery is visible
- Release Vol+

### Enter Fastboot MOde

- No known keycombo. Can access through `adb reboot bootloader` though.

### Enter FEL Mode

- Power off device (fully)
- Hold Vol+ key
- Press power button 10 times
- Wait 30 seconds (or less sometimes)
- Device will show up to computer

### Android Safe MOde

- Hold volume down after boot logo shows up


## Stock ROM Stuff

### Root Stock ROM

- Enable USB debugging in developer settings
- Run `adb reboot recovery` with tablet connected to your laptop
- In recovery, select install from adb
- On laptop, run `adb sideload tools-notmine/Update-SuperSU-THISONEWORKS-STOCK_KITKAT.zip
- Wait for install
- Reboot
- Make sure to launch supersu app once before trying to get root in adb shell


### Dump stock rom

This will dump the stock rom from your tablet.

- Insert FAT32 formatted SD card into tablet. Make sure it is mounted (`/mnt/extsd`)
- `adb push tools-mine/dump_stock.sh /data/local/temp`
- `adb shell su -c "sh /data/local/tmp/dump_stock.sh"`
- Wait for it to finish. There will be gzipped images of each nand partition on your sd card
- See `stock/part_map.txt` for what each nand partition in


### Stock ROM info

Several files with information are stored in `stock/`


## Custom Recovery (TWRP)

### TWRP

*Note: Not functional / built yet.*

#### Device Tree creation

My existing device tree is located [here](https://github.com/MB3hel/android_device_azpen_along-6051). The following is documentation of the process I used to create it.

- Tested on Ubuntu 22.04 LTS (amd64)
- From extracted stock rom I have recovery.img
- Will use [twrpdtgen](https://github.com/twrpdtgen/twrpdtgen). Install it.
- Install other tools `sudo apt install cpio git-all mkbootimg`
- Setup folder (sh scripts from `tools-mine/`)
    ```
    - twrp/
        - recovery.img
        - extract_recovery.sh
        - pack-recovery.sh
        - unpack_bootimg.py
    ```
- Run `./extract-recovery.sh recovery.img recovery/`
- In extracted recovery's extracted ramdisk, replace `default.prop` contents with the following
    ```
    #
    # ADDITIONAL_DEFAULT_PROPERTIES
    #
    ro.secure=1
    ro.allow.mock.location=0
    ro.debuggable=0
    persist.sys.usb.config=none
    # begin build properties
    # autogenerated by buildinfo.sh
    ro.build.id=AZPEN
    ro.build.display.id=AZPEN.20170802
    ro.build.version.incremental=20170802
    ro.build.version.sdk=19
    ro.build.version.security_patch=none
    ro.product.first_api_level=19
    ro.build.version.codename=REL
    ro.build.version.release=4.4.2
    ro.build.date=Wed Aug  2 11:04:37 CST 2017
    ro.build.date.utc=1501643077
    ro.build.type=user
    ro.build.user=yyb
    ro.build.host=yyb-pc
    ro.build.tags=test-keys
    ro.product.model=A746
    ro.product.brand=A746
    ro.product.name=along_6051
    ro.product.device=along-6051
    ro.product.board=exdroid
    ro.product.cpu.abi=armeabi-v7a
    ro.product.cpu.abi2=armeabi
    ro.product.cpu.abilist=armeabi-v7a,armeabi
    ro.product.manufacturer=A746
    ro.product.locale.language=en
    ro.product.locale.region=US
    ro.wifi.channels=
    ro.board.platform=polaris
    # ro.build.product is obsolete; use ro.product.device
    ro.build.product=along-6051
    # Do not try to parse ro.build.description or .fingerprint
    ro.build.description=AZPEN 20170802
    ro.build.fingerprint=A746/along_6051/along-6051:4.4.2/AZPEN/20170802:user/test-keys
    ro.build.characteristics=tablet
    # end build properties

    #
    # ADDITIONAL_BUILD_PROPERTIES
    #
    ro.com.android.dateformat=MM-dd-yyyy
    ro.config.ringtone=Ring_Synth_04.ogg
    ro.config.notification_sound=pixiedust.ogg
    ro.carrier=wifi-only
    ro.config.alarm_alert=Alarm_Classic.ogg
    ro.zygote.disable_gl_preload=true
    persist.sys.strictmode.visual=0
    persist.sys.strictmode.disable=1
    ro.opengles.version=131072
    ro.kernel.android.checkjni=0
    ro.reversion.aw_sdk_tag=exdroid4.4.2_r2-a33-v2.0
    ro.sys.cputype=QuadCore-A33
    wifi.interface=wlan0
    wifi.supplicant_scan_interval=15
    keyguard.no_require_sim=true
    ro.sys.network_location=true
    persist.demo.hdmirotationlock=0
    drm.service.enabled=true
    dalvik.vm.heapstartsize=5m
    dalvik.vm.heapgrowthlimit=48m
    dalvik.vm.heapsize=128m
    dalvik.vm.heaptargetutilization=0.75
    dalvik.vm.heapminfree=512k
    dalvik.vm.heapmaxfree=2m
    ro.sw.embeded.telephony=false
    persist.sys.timezone=America/North_Dakota/Center
    persist.sys.language=en
    persist.sys.country=US
    ro.sys.storage_type=emulated
    persist.sys.usb.config=mtp,adb
    ro.udisk.lable=A746
    ro.font.scale=1.3
    ro.hwa.force=false
    rw.logger=0
    ro.g3.display=true
    ro.sys.bootfast=false
    debug.hwc.showfps=0
    debug.hwui.render_dirty_regions=false
    ro.sys.mutedrm=true
    ro.adb.secure=0
    persist.service.adb.enable=0
    ro.sf.lcd_density=160
    ro.sf.rotation=0
    ro.product.firmware=v2.0
    ro.setupwizard.mode=OPTIONAL
    ro.com.google.gmsversion=4.4_r3
    persist.sys.dalvik.vm.lib=libdvm.so
    dalvik.vm.dexopt-flags=v=n,m=y
    net.bt.name=Android
    dalvik.vm.stack-trace-file=/data/anr/traces.txt

    # begin fota properties
    ro.fota.platform=AW_A23_KK
    ro.fota.type=pad
    ro.fota.oem=along_A23_KK
    ro.fota.device=A746
    ro.fota.version=A74620170802-1104
    # end fota properties
    ```
- Rebuild recovery image (run in `recovery/` folder) `./pack-recovery.sh ../recovery-modified.img`
- File tree should now look like the following
     ```
    - twrp/
        - recovery/
        - recovery.img
        - recovery-modified.img
        - extract_recovery.sh
        - pack-recovery.sh
        - unpack_bootimg.py
    ```
- Run `python3 -m twrpdtgen recovery-modified.img`
- Resultant device tree is in `output/a746/along-6051`

- Manual Modifications (a23 repo served as an example motivating most of these changes)
    - All `.ko` files from extracted recovery ramdisk added to `recovery/root` in device tree
    - Add `fstab.sun8i` from extracted recovery ramdisk to `recovery/root` in device tree
    - `recovery.fstab` (generated) moved to `recovery/root/etc`
    - `recovery/root/etc/recovery.fstab` modified to use `mmcblk0p1` for external sd card
    - Create `recovery/Android.mk` to load all rc files
    - Modify `device.mk` to include ko files and kernel path


## Unbricking / fixing bootloops

*Note: If the tablet bootloops (ie due to bad recovery flashed) it will likely be unrecoverable until the battery dies.*

### FEL Mode

Allwinner devices have a low level "FEL" mode used to write the NAND. This can be triggered various ways. 

On this device (even if bootlooping) hold volume down (either key should work, but volume down seems important to break the bootloop). Then hold power (still holding volume down). Wait until the screen turns off for 5 seconds. Then release power (still holding vol down) and press the power button 10 times. Release the vol down button after a few seconds. The device should be in FEL mode.

FEL mode can also be triggered with a special SD card image. See [here](https://linux-sunxi.org/FEL) for details.

In FEL mode, the [Linux Sunxi Tools](https://github.com/linux-sunxi/sunxi-tools) may be helpful.

To unbrick, you would need a stock from from the manufacturer in Allwinner format. This could be flashed with [LiveSuit](https://linux-sunxi.org/LiveSuit) (maybe) or PhoenixSuit. Azpen's "Upgrade Tool for Allwinner" is Phoenix.

*I do not currently have a ROM from Azpen, but it may be possible to pack my dumped ROM correctly. [This](https://linux-sunxi.org/LiveSuit_images) page is a good place to start. There are pack tools in the lichee archive in the Allwinner Android SDK.*



### Fastboot

Fastboot can be accessed using `adb reboot bootloader`, but I have yet to find a key combo to access it (probably not possible). Theoretically, one could flash a partition in fastboot. But this seems useless in practice if we can't get to fastboot.



### uBoot Console

If we could access the uBoot console, we could probably manually boot to fastboot using `fastboot usb 0`. There are UART pads on this tablet's board (requires opening tablet). This is untested, but persumably similar to A741 (info [here](https://linux-sunxi.org/Azpen_A741)). However, the console may not accept input due to sharing with the SD card (again, untested).

Theoretically, FEL could also be used to flash a custom uboot build to work around this (differnet UART port), but we'd need to be able to build uboot for this device. Currently not sure what that would entail. It is possible a generic A33 1024x600 build would work. But again, UNTESTED!


### SD Card Boot

It is likely (untested) that this device would boot from SD card before booting NAND. Thus, a properly constructed SD card may allow booting of a linux or android environment. `dd` could then be used to manually flash the stock rom dumped from my device.

[This process](https://linux-sunxi.org/Boot_Android_from_SdCard) may be usable with my dumped stock rom to make a bootable android SD card to unbrick. But would need to build uboot.
