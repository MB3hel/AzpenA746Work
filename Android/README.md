# Azpen A746 Android Work

## Links

- [Dumped Stock ROM](https://1drv.ms/u/s!AhjgTI1qxX9xhpNCqEHOxzOVnvZi5w?e=kCeBIt): Stock ROM I dumped from my tablet. *I have not determined if the stock rom on these tablets contains malware. Use at your own risk.*
- [Allwinner A33 SDK](https://linux-sunxi.org/A33#Android_SDK): External source
- [Vendor Folder](https://1drv.ms/u/s!AhjgTI1qxX9xhpNBvHlxAAMYwv4KZw?e=F8SGcF): `/system/vendor` folder from my tablet

<br />

- [Device Tree](https://github.com/MB3hel/android_device_azpen_along-6051)

## STock ROM Stuff

### Root Stock ROM

- Enable USB debugging in developer settings
- Run `adb reboot recovery` with tablet connected to your laptop
- In recovery, select install from adb
- On laptop, run `adb sideload tools-notmine/Update-SuperSU-THISONEWORKS-STOCK_KITKAT.zip
- Wait for install
- Reboot
- Make sure to launch supersu app once before trying to get root in adb shell


### Dump stock rom

This will dump the stock rom from your tablet.

- Insert FAT32 formatted SD card into tablet. Make sure it is mounted (`/mnt/extsd`)
- `adb push tools-mine/dump_stock.sh /data/local/temp`
- `adb shell su -c "sh /data/local/tmp/dump_stock.sh"`
- Wait for it to finish. There will be gzipped images of each nand partition on your sd card
- See `stock/part_map.txt` for what each nand partition in


### Stock ROM info

Several files with information are stored in `stock/`


## Custom Recovery (TWRP)

### UNTESTED NOT MINE

In `tools/notmine` there is `A33 TWRP+install v1.2.rar`. This is a generic A33 based tablet TWRP. **I did not build this and have not tested yet.**. The installer scripts and instructions will certainly not work (wrong nand partition).


### My TWRP

*Note: Not fully functional / built yet.*

#### Device Tree creation

Existing device tree is located [here](https://github.com/MB3hel/android_device_azpen_along-6051). The following is documentation of the process I used to create it.

- Tested on Ubuntu 22.04 LTS (amd64)
- From extracted stock rom I have recovery.img
- Will use [twrpdtgen](https://github.com/twrpdtgen/twrpdtgen). Install it.
- Install other tools `sudo apt install cpio git-all mkbootimg`
- Setup folder (sh scripts from `tools-mine/`)
    ```
    - twrp/
        - recovery.img
        - extract_recovery.sh
        - pack-recovery.sh
        - unpack_bootimg.py
    ```
- Run `./extract-recovery.sh recovery.img recovery/`
- In extracted recovery's extracted ramdisk, replace `default.prop` contents with the following
    ```
    #
    # ADDITIONAL_DEFAULT_PROPERTIES
    #
    ro.secure=1
    ro.allow.mock.location=0
    ro.debuggable=0
    persist.sys.usb.config=none
    # begin build properties
    # autogenerated by buildinfo.sh
    ro.build.id=AZPEN
    ro.build.display.id=AZPEN.20170802
    ro.build.version.incremental=20170802
    ro.build.version.sdk=19
    ro.build.version.security_patch=none
    ro.product.first_api_level=19
    ro.build.version.codename=REL
    ro.build.version.release=4.4.2
    ro.build.date=Wed Aug  2 11:04:37 CST 2017
    ro.build.date.utc=1501643077
    ro.build.type=user
    ro.build.user=yyb
    ro.build.host=yyb-pc
    ro.build.tags=test-keys
    ro.product.model=A746
    ro.product.brand=A746
    ro.product.name=along_6051
    ro.product.device=along-6051
    ro.product.board=exdroid
    ro.product.cpu.abi=armeabi-v7a
    ro.product.cpu.abi2=armeabi
    ro.product.cpu.abilist=armeabi-v7a,armeabi
    ro.product.manufacturer=A746
    ro.product.locale.language=en
    ro.product.locale.region=US
    ro.wifi.channels=
    ro.board.platform=polaris
    # ro.build.product is obsolete; use ro.product.device
    ro.build.product=along-6051
    # Do not try to parse ro.build.description or .fingerprint
    ro.build.description=AZPEN 20170802
    ro.build.fingerprint=A746/along_6051/along-6051:4.4.2/AZPEN/20170802:user/test-keys
    ro.build.characteristics=tablet
    # end build properties

    #
    # ADDITIONAL_BUILD_PROPERTIES
    #
    ro.com.android.dateformat=MM-dd-yyyy
    ro.config.ringtone=Ring_Synth_04.ogg
    ro.config.notification_sound=pixiedust.ogg
    ro.carrier=wifi-only
    ro.config.alarm_alert=Alarm_Classic.ogg
    ro.zygote.disable_gl_preload=true
    persist.sys.strictmode.visual=0
    persist.sys.strictmode.disable=1
    ro.opengles.version=131072
    ro.kernel.android.checkjni=0
    ro.reversion.aw_sdk_tag=exdroid4.4.2_r2-a33-v2.0
    ro.sys.cputype=QuadCore-A33
    wifi.interface=wlan0
    wifi.supplicant_scan_interval=15
    keyguard.no_require_sim=true
    ro.sys.network_location=true
    persist.demo.hdmirotationlock=0
    drm.service.enabled=true
    dalvik.vm.heapstartsize=5m
    dalvik.vm.heapgrowthlimit=48m
    dalvik.vm.heapsize=128m
    dalvik.vm.heaptargetutilization=0.75
    dalvik.vm.heapminfree=512k
    dalvik.vm.heapmaxfree=2m
    ro.sw.embeded.telephony=false
    persist.sys.timezone=America/North_Dakota/Center
    persist.sys.language=en
    persist.sys.country=US
    ro.sys.storage_type=emulated
    persist.sys.usb.config=mtp,adb
    ro.udisk.lable=A746
    ro.font.scale=1.3
    ro.hwa.force=false
    rw.logger=0
    ro.g3.display=true
    ro.sys.bootfast=false
    debug.hwc.showfps=0
    debug.hwui.render_dirty_regions=false
    ro.sys.mutedrm=true
    ro.adb.secure=0
    persist.service.adb.enable=0
    ro.sf.lcd_density=160
    ro.sf.rotation=0
    ro.product.firmware=v2.0
    ro.setupwizard.mode=OPTIONAL
    ro.com.google.gmsversion=4.4_r3
    persist.sys.dalvik.vm.lib=libdvm.so
    dalvik.vm.dexopt-flags=v=n,m=y
    net.bt.name=Android
    dalvik.vm.stack-trace-file=/data/anr/traces.txt

    # begin fota properties
    ro.fota.platform=AW_A23_KK
    ro.fota.type=pad
    ro.fota.oem=along_A23_KK
    ro.fota.device=A746
    ro.fota.version=A74620170802-1104
    # end fota properties
    ```
- Rebuild recovery image (run in `recovery/` folder) `./pack-recovery.sh ../recovery-modified.img`
- File tree should now look like the following
     ```
    - twrp/
        - recovery/
        - recovery.img
        - recovery-modified.img
        - extract_recovery.sh
        - pack-recovery.sh
        - unpack_bootimg.py
    ```
- Run `python3 -m twrpdtgen recovery-modified.img`
- Resultant device tree is in `output/a746/along-6051`

- Manual Modifications (a23 repo served as an example motivating most of these changes)
    - All `.ko` files from extracted recovery ramdisk added to `recovery/root` in device tree
    - Add `fstab.sun8i` from extracted recovery ramdisk to `recovery/root` in device tree
    - `recovery.fstab` (generated) moved to `recovery/root/etc`
    - `recovery/root/etc/recovery.fstab` modified to use `mmcblk0p1` for external sd card
    - Create `recovery/Android.mk` to load all rc files
    - Modify `device.mk` to include ko files and kernel path
